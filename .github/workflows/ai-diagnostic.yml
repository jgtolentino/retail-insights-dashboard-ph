name: AI Code Diagnostics & Auto-Fix

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  ai-diagnostics:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        attempt: [1, 2]  # first run, optional retry after auto-fix
    
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: npm

      - name: Install deps
        run: npm ci

      - name: Run AI Diagnostics
        id: diagnostics
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          ATTEMPT: ${{ matrix.attempt }}
        run: |
          echo "Running AI diagnostics (attempt ${{ matrix.attempt }})..."
          node scripts/ai-diagnostics.js
          echo "diagnostics_failed=$?" >> $GITHUB_OUTPUT

      - name: Apply Auto-fixes (first attempt only)
        if: ${{ matrix.attempt == 1 && steps.diagnostics.outputs.diagnostics_failed != '0' }}
        id: autofix
        run: |
          echo "Applying AI auto-fixes..."
          node scripts/ai-autofix.js
          echo "fixes_applied=$?" >> $GITHUB_OUTPUT

      - name: Create PR with fixes
        if: ${{ matrix.attempt == 1 && steps.autofix.outputs.fixes_applied == '0' }}
        uses: peter-evans/create-pull-request@v5
        with:
          title: "ü§ñ AI Auto-fixes: production-readiness"
          body: |
            ## ü§ñ Automated fixes generated by AI diagnostic agent
            
            This PR contains automated fixes for the following issues:
            - See `ai-diagnostic-report.json` for full details
            
            ### ‚ö†Ô∏è Important
            - These fixes were automatically generated
            - Please review carefully before merging
            - If tests still fail after merge, manual intervention required
          branch: ai-autofix-${{ github.run_number }}
          commit-message: "fix: AI automated production-readiness fixes"

      - name: Upload diagnostic report
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: ai-diagnostic-report-attempt-${{ matrix.attempt }}
          path: |
            ai-diagnostic-report.json
            qa-results.log

      - name: Bail out if still failing on retry
        if: ${{ failure() && matrix.attempt == 2 }}
        run: |
          echo "‚ùå AI patch cycle failed after retry ‚Äì human review required"
          echo "Creating GitHub issue for manual intervention..."
          exit 1