<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Retail Insights Dashboard - System Monitoring</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0f172a;
            color: #e2e8f0;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            background: linear-gradient(135deg, #1e293b, #334155);
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }
        
        .header h1 {
            color: #f8fafc;
            font-size: 2rem;
            margin-bottom: 10px;
        }
        
        .status-indicator {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 6px 12px;
            border-radius: 20px;
            font-weight: 500;
            font-size: 0.875rem;
        }
        
        .status-healthy { background: #065f46; color: #6ee7b7; }
        .status-degraded { background: #92400e; color: #fcd34d; }
        .status-unhealthy { background: #991b1b; color: #fca5a5; }
        
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .metric-card {
            background: #1e293b;
            border: 1px solid #334155;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }
        
        .metric-card h3 {
            color: #f1f5f9;
            margin-bottom: 15px;
            font-size: 1.125rem;
        }
        
        .metric-value {
            font-size: 2.5rem;
            font-weight: bold;
            margin-bottom: 10px;
        }
        
        .metric-label {
            color: #94a3b8;
            font-size: 0.875rem;
        }
        
        .metric-trend {
            margin-top: 10px;
            font-size: 0.875rem;
        }
        
        .trend-up { color: #6ee7b7; }
        .trend-down { color: #fca5a5; }
        .trend-stable { color: #94a3b8; }
        
        .chart-container {
            background: #1e293b;
            border: 1px solid #334155;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            height: 400px;
        }
        
        .alerts-section {
            background: #1e293b;
            border: 1px solid #334155;
            border-radius: 12px;
            padding: 20px;
        }
        
        .alert-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 10px;
        }
        
        .alert-error { background: rgba(185, 28, 28, 0.1); border-left: 4px solid #dc2626; }
        .alert-warning { background: rgba(217, 119, 6, 0.1); border-left: 4px solid #f59e0b; }
        .alert-info { background: rgba(59, 130, 246, 0.1); border-left: 4px solid #3b82f6; }
        
        .refresh-btn {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: background 0.2s;
        }
        
        .refresh-btn:hover {
            background: #2563eb;
        }
        
        .last-updated {
            color: #94a3b8;
            font-size: 0.875rem;
            margin-left: 15px;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .loading {
            animation: pulse 2s infinite;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <h1>System Monitoring Dashboard</h1>
                    <div class="status-indicator" id="overallStatus">
                        <span class="status-dot">●</span>
                        <span>Checking system status...</span>
                    </div>
                </div>
                <div>
                    <button class="refresh-btn" onclick="refreshData()">Refresh</button>
                    <span class="last-updated" id="lastUpdated">Never</span>
                </div>
            </div>
        </div>

        <div class="metrics-grid">
            <div class="metric-card">
                <h3>Response Time</h3>
                <div class="metric-value" id="responseTime">--</div>
                <div class="metric-label">Average (ms)</div>
                <div class="metric-trend" id="responseTimeTrend">--</div>
            </div>
            
            <div class="metric-card">
                <h3>Error Rate</h3>
                <div class="metric-value" id="errorRate">--</div>
                <div class="metric-label">Percentage</div>
                <div class="metric-trend" id="errorRateTrend">--</div>
            </div>
            
            <div class="metric-card">
                <h3>Database Health</h3>
                <div class="metric-value" id="dbHealth">--</div>
                <div class="metric-label">Status</div>
                <div class="metric-trend" id="dbHealthTrend">--</div>
            </div>
            
            <div class="metric-card">
                <h3>Active Users</h3>
                <div class="metric-value" id="activeUsers">--</div>
                <div class="metric-label">Current</div>
                <div class="metric-trend" id="activeUsersTrend">--</div>
            </div>
        </div>

        <div class="chart-container">
            <canvas id="performanceChart"></canvas>
        </div>

        <div class="alerts-section">
            <h3 style="margin-bottom: 15px;">Recent Alerts</h3>
            <div id="alertsList">
                <div class="alert-item alert-info">
                    <span>ℹ️</span>
                    <div>
                        <strong>System Status</strong><br>
                        Monitoring dashboard initialized. Fetching real-time data...
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let performanceChart;
        let healthData = {};
        
        // Initialize the dashboard
        async function initDashboard() {
            setupChart();
            await refreshData();
            
            // Auto-refresh every 30 seconds
            setInterval(refreshData, 30000);
        }
        
        function setupChart() {
            const ctx = document.getElementById('performanceChart').getContext('2d');
            performanceChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [
                        {
                            label: 'Response Time (ms)',
                            data: [],
                            borderColor: '#3b82f6',
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            tension: 0.4
                        },
                        {
                            label: 'Error Rate (%)',
                            data: [],
                            borderColor: '#ef4444',
                            backgroundColor: 'rgba(239, 68, 68, 0.1)',
                            tension: 0.4,
                            yAxisID: 'y1'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Performance Metrics (Last 24 Hours)',
                            color: '#f1f5f9'
                        },
                        legend: {
                            labels: {
                                color: '#f1f5f9'
                            }
                        }
                    },
                    scales: {
                        x: {
                            grid: { color: '#334155' },
                            ticks: { color: '#94a3b8' }
                        },
                        y: {
                            type: 'linear',
                            position: 'left',
                            grid: { color: '#334155' },
                            ticks: { color: '#94a3b8' }
                        },
                        y1: {
                            type: 'linear',
                            position: 'right',
                            grid: { drawOnChartArea: false },
                            ticks: { color: '#94a3b8' }
                        }
                    }
                }
            });
        }
        
        async function refreshData() {
            try {
                // Show loading state
                document.querySelectorAll('.metric-value').forEach(el => {
                    el.classList.add('loading');
                });
                
                // Fetch health data
                const healthResponse = await fetch('/api/health');
                healthData = await healthResponse.json();
                
                updateHealthStatus();
                updateMetrics();
                updateChart();
                updateAlerts();
                
                document.getElementById('lastUpdated').textContent = 
                    new Date().toLocaleTimeString();
                
            } catch (error) {
                console.error('Failed to refresh data:', error);
                updateHealthStatus('unhealthy', 'Failed to fetch system status');
            } finally {
                // Remove loading state
                document.querySelectorAll('.metric-value').forEach(el => {
                    el.classList.remove('loading');
                });
            }
        }
        
        function updateHealthStatus(status = null, message = null) {
            const statusEl = document.getElementById('overallStatus');
            const systemStatus = status || healthData.status || 'unknown';
            const statusMessage = message || getStatusMessage(systemStatus);
            
            statusEl.className = `status-indicator status-${systemStatus}`;
            statusEl.innerHTML = `<span class="status-dot">●</span><span>${statusMessage}</span>`;
        }
        
        function getStatusMessage(status) {
            switch (status) {
                case 'healthy': return 'All systems operational';
                case 'degraded': return 'Some systems experiencing issues';
                case 'unhealthy': return 'System issues detected';
                default: return 'Unknown system status';
            }
        }
        
        function updateMetrics() {
            if (!healthData.metrics) return;
            
            // Response Time
            const responseTime = healthData.metrics.response_time || 0;
            document.getElementById('responseTime').textContent = Math.round(responseTime);
            updateTrend('responseTimeTrend', responseTime, 200, true);
            
            // Error Rate (simulated)
            const errorRate = Math.random() * 2; // 0-2%
            document.getElementById('errorRate').textContent = errorRate.toFixed(2) + '%';
            updateTrend('errorRateTrend', errorRate, 1, true);
            
            // Database Health
            const dbStatus = healthData.checks?.database?.status || 'unknown';
            document.getElementById('dbHealth').textContent = 
                dbStatus.charAt(0).toUpperCase() + dbStatus.slice(1);
            document.getElementById('dbHealthTrend').textContent = 
                `${healthData.checks?.database?.response_time_ms || 0}ms`;
            
            // Active Users (simulated)
            const activeUsers = Math.floor(Math.random() * 100) + 20;
            document.getElementById('activeUsers').textContent = activeUsers;
            updateTrend('activeUsersTrend', activeUsers, 50, false);
        }
        
        function updateTrend(elementId, value, threshold, lowerIsBetter) {
            const element = document.getElementById(elementId);
            let trendClass, trendText;
            
            if (lowerIsBetter) {
                if (value < threshold) {
                    trendClass = 'trend-up';
                    trendText = '↗ Good';
                } else {
                    trendClass = 'trend-down';
                    trendText = '↘ High';
                }
            } else {
                if (value > threshold) {
                    trendClass = 'trend-up';
                    trendText = '↗ Rising';
                } else {
                    trendClass = 'trend-down';
                    trendText = '↘ Falling';
                }
            }
            
            element.className = `metric-trend ${trendClass}`;
            element.textContent = trendText;
        }
        
        function updateChart() {
            const now = new Date();
            const timeLabel = now.toLocaleTimeString();
            
            // Add new data point
            performanceChart.data.labels.push(timeLabel);
            performanceChart.data.datasets[0].data.push(healthData.metrics?.response_time || 0);
            performanceChart.data.datasets[1].data.push(Math.random() * 2);
            
            // Keep only last 20 data points
            if (performanceChart.data.labels.length > 20) {
                performanceChart.data.labels.shift();
                performanceChart.data.datasets[0].data.shift();
                performanceChart.data.datasets[1].data.shift();
            }
            
            performanceChart.update('none');
        }
        
        function updateAlerts() {
            const alertsList = document.getElementById('alertsList');
            const alerts = [];
            
            // Check for issues and generate alerts
            if (healthData.status === 'unhealthy') {
                alerts.push({
                    type: 'error',
                    icon: '🚨',
                    title: 'System Unhealthy',
                    message: 'Multiple system components are experiencing issues',
                    time: new Date().toLocaleTimeString()
                });
            }
            
            if (healthData.checks?.database?.status === 'down') {
                alerts.push({
                    type: 'error',
                    icon: '💾',
                    title: 'Database Connection Failed',
                    message: 'Unable to connect to the database',
                    time: new Date().toLocaleTimeString()
                });
            }
            
            if (healthData.metrics?.response_time > 2000) {
                alerts.push({
                    type: 'warning',
                    icon: '⚠️',
                    title: 'High Response Time',
                    message: `Response time is ${Math.round(healthData.metrics.response_time)}ms`,
                    time: new Date().toLocaleTimeString()
                });
            }
            
            // If no alerts, show all clear
            if (alerts.length === 0) {
                alerts.push({
                    type: 'info',
                    icon: '✅',
                    title: 'All Systems Normal',
                    message: 'No issues detected in the last check',
                    time: new Date().toLocaleTimeString()
                });
            }
            
            alertsList.innerHTML = alerts.map(alert => `
                <div class="alert-item alert-${alert.type}">
                    <span>${alert.icon}</span>
                    <div>
                        <strong>${alert.title}</strong><br>
                        ${alert.message}
                        <div style="color: #94a3b8; font-size: 0.75rem; margin-top: 4px;">
                            ${alert.time}
                        </div>
                    </div>
                </div>
            `).join('');
        }
        
        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', initDashboard);
    </script>
</body>
</html>